<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¾ç»´æ–¯å¯¹è¯ç³»ç»Ÿ</title>
    <!-- å¼•å…¥Bootstrap CSS -->
    <link href="https://cdn.staticfile.net/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.staticfile.net/marked/12.0.0/marked.min.js"></script>
    <!-- å¼•å…¥ä»£ç é«˜äº®åº“ -->
    <link href="https://cdn.staticfile.net/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.net/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.staticfile.net/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- å¼•å…¥Font Awesome -->
    <link href="https://cdn.staticfile.net/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* åŸºç¡€æ ·å¼ */
        :root {
            --primary-color: #165DFF;
            --secondary-color: #E8F3FF;
            --accent-color: #FF7D00;
            --text-color: #333333;
            --text-light: #666666;
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* æš—æ¨¡å¼ */
        .dark-mode {
            --primary-color: #3B82F6;
            --secondary-color: #1E3A8A;
            --accent-color: #F97316;
            --text-color: #E0E0E0;
            --text-light: #A0A0A0;
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --border-color: #333333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* å®¹å™¨æ ·å¼ */
        .container-fluid {
            padding: 20px;
        }

        /* èŠå¤©å®¹å™¨ */
        .chat-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .chat-header h3 {
            margin: 0;
            font-weight: 600;
            font-size: 1.25rem;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* èŠå¤©ä¸»ä½“ */
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            justify-content: flex-end;
        }

        .ai-message {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .user-message .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-message .message-bubble {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        /* æ¶ˆæ¯ä¿¡æ¯ */
        .message-info {
            font-size: 0.75rem;
            color: var(--text-light);
            margin: 4px 8px;
            display: flex;
            align-items: center;
        }

        .user-message .message-info {
            order: 1;
        }

        .ai-message .message-info {
            order: 1;
        }

        .message-time {
            margin-left: 4px;
        }

        .message-status {
            display: flex;
            align-items: center;
            margin-left: 4px;
        }

        /* æ¶ˆæ¯å†…å®¹ */
        .message-content {
            line-height: 1.6;
            font-size: 14px;
        }

        .markdown-content {
            text-align: left;
            line-height: 1.6;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .markdown-content h1 {
            font-size: 1.4rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        .markdown-content h2 {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 6px;
        }

        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: var(--accent-color);
        }

        .markdown-content pre {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 16px 0;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: var(--text-color);
            font-size: 13px;
            line-height: 1.5;
        }

        .markdown-content ul, .markdown-content ol {
            padding-left: 24px;
            margin: 12px 0;
        }

        .markdown-content ul li, .markdown-content ol li {
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .markdown-content p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-light);
            font-style: italic;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .markdown-content th, .markdown-content td {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .markdown-content th {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        .markdown-content tr:nth-child(even) {
            background-color: var(--bg-color);
        }

        /* æ¶ˆæ¯æ°”æ³¡å¢å¼ºæ•ˆæœ */
        .message-bubble {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .message-bubble:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }

        .ai-message .message-bubble {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border-bottom-left-radius: 6px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .user-message .message-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 6px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border-bottom-left-radius: 20px;
        }

        /* æ¶ˆæ¯ä¿¡æ¯å¢å¼º */
        .message-info {
            font-size: 0.75rem;
            color: var(--text-light);
            margin: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-info {
            background-color: var(--bg-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* æ¶ˆæ¯åŠ¨ç”»å¢å¼º */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-end;
            animation: fadeIn 0.4s ease-out;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 3px;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .chat-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        /* èŠå¤©åº•éƒ¨ */
        .chat-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: var(--transition);
        }

        /* æ¨¡å‹é€‰æ‹© */
        .model-selector {
            margin-bottom: 16px;
        }

        .model-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: var(--transition);
        }

        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(22, 93, 255, 0.25);
        }

        /* é€‰é¡¹å¼€å…³ */
        .form-switch {
            margin-bottom: 16px;
        }

        .form-check-label {
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-group {
            margin-bottom: 16px;
        }

        .form-control {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px 0 0 8px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(22, 93, 255, 0.25);
        }

        .btn {
            border-radius: 0 8px 8px 0;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #0E47D9;
            border-color: #0E47D9;
            transform: translateY(-1px);
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .action-btn {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* å³ä¾§é¢æ¿ */
        .side-panel {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        /* é¢æ¿å¤´éƒ¨ */
        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: var(--transition);
        }

        .panel-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* æ ‡ç­¾é¡µ */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: var(--transition);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background-color: var(--bg-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        /* é¢æ¿å†…å®¹ */
        .tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* å¥åº·æ•°æ® */
        .health-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-unit {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            transition: var(--transition);
            border-radius: 8px;
        }

        .btn-secondary {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        /* å¼‚å¸¸æ£€æµ‹ */
        #anomalies-list {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
        }

        .anomaly-item {
            background-color: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--accent-color);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .anomaly-item:hover {
            transform: translateX(4px);
        }

        .anomaly-item.low {
            border-left-color: #10B981;
        }

        .anomaly-item.medium {
            border-left-color: #F59E0B;
        }

        .anomaly-item.high {
            border-left-color: #EF4444;
        }

        /* IoTè®¾å¤‡ */
        .iot-devices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .device-card {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .device-card h3 {
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 500;
        }

        .device-status {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.on {
            background-color: #10B981;
            box-shadow: 0 0 8px #10B981;
        }

        .status-indicator.off {
            background-color: #6B7280;
        }

        .device-controls {
            display: flex;
            gap: 8px;
        }

        .device-btn {
            flex: 1;
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .device-btn:hover {
            background-color: #0E47D9;
            transform: translateY(-1px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0;
            }

            .chat-container,
            .side-panel {
                border-radius: 0;
                height: 100vh;
            }

            .side-panel {
                position: fixed;
                right: -100%;
                top: 0;
                width: 100%;
                z-index: 1000;
                transition: var(--transition);
            }

            .side-panel.open {
                right: 0;
            }

            .message-bubble {
                max-width: 85%;
            }

            .health-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .iot-devices {
                grid-template-columns: 1fr;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            position: relative;
            width: 20px;
            height: 20px;
        }

        .loading div {
            position: absolute;
            top: 3px;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--primary-color);
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }

        .loading div:nth-child(1) {
            left: 4px;
            animation: loading1 0.6s infinite;
        }

        .loading div:nth-child(2) {
            left: 4px;
            animation: loading2 0.6s infinite;
        }

        .loading div:nth-child(3) {
            left: 16px;
            animation: loading2 0.6s infinite;
        }

        .loading div:nth-child(4) {
            left: 28px;
            animation: loading3 0.6s infinite;
        }

        @keyframes loading1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        @keyframes loading3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }

        @keyframes loading2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(12px, 0); }
        }

        /* è¯­éŸ³å½•åˆ¶åŠ¨ç”» */
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #EF4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-upload {
            position: relative;
            margin: 10px 0;
        }

        .file-upload input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background-color: #10B981;
            color: white;
        }

        .notification.error {
            background-color: #EF4444;
            color: white;
        }

        .notification.info {
            background-color: var(--primary-color);
            color: white;
        }

        /* å¿«æ·å‘½ä»¤ */
        .quick-commands {
            margin-bottom: 16px;
        }

        .quick-commands h5 {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .quick-command-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-command-btn {
            padding: 6px 12px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-command-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§èŠå¤©åŒºåŸŸ -->
            <div class="col-md-8">
                <div class="chat-container">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="chat-header">
                        <h3>è´¾ç»´æ–¯å¯¹è¯ç³»ç»Ÿ</h3>
                        <button class="theme-toggle" id="themeToggle">
                            <i class="fa fa-moon-o"></i>
                        </button>
                    </div>

                    <!-- èŠå¤©ä¸»ä½“ -->
                    <div class="chat-body" id="chatBody">
                        <!-- å¯¹è¯å†å²å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        <div class="message ai-message">
                            <div class="message-bubble">
                                <div class="message-content">ä½ å¥½ï¼æˆ‘æ˜¯è´¾ç»´æ–¯ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚</div>
                                <div class="message-info">
                                    <span class="model-info">ç³»ç»Ÿæ¶ˆæ¯</span>
                                    <span class="message-time">ç°åœ¨</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- èŠå¤©åº•éƒ¨ -->
                    <div class="chat-footer">
                        <!-- å¿«æ·å‘½ä»¤ -->
                        <div class="quick-commands">
                            <h5>å¿«æ·å‘½ä»¤</h5>
                            <div class="quick-command-buttons">
                                <button class="quick-command-btn" data-command="ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ">å¤©æ°”æŸ¥è¯¢</button>
                                <button class="quick-command-btn" data-command="å¸®æˆ‘åˆ†æè¿™å¼ å›¾ç‰‡">å›¾åƒåˆ†æ</button>
                                <button class="quick-command-btn" data-command="è¿è¡Œè¿™æ®µä»£ç ">ä»£ç æ‰§è¡Œ</button>
                                <button class="quick-command-btn" data-command="ç¿»è¯‘è¿™å¥è¯">ç¿»è¯‘</button>
                            </div>
                        </div>

                        <!-- æ¨¡å‹é€‰æ‹© -->
                        <div class="model-selector">
                            <label for="modelSelect">é€‰æ‹©æ¨¡å‹ï¼š</label>
                            <select class="form-select" id="modelSelect">
                                <option value="aliyun" selected>é˜¿é‡Œå¤§æ¨¡å‹ (Qwen-Max) - ä¸­æ–‡äº¤æµé»˜è®¤</option>
                                <option value="ollama">Ollama (Llama3) - å¤‡ç”¨æ¨¡å‹</option>
                            </select>
                        </div>

                        <!-- è¯­éŸ³å›å¤å¼€å…³ -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="voiceReplySwitch">
                            <label class="form-check-label" for="voiceReplySwitch">å¯ç”¨è¯­éŸ³å›å¤</label>
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." id="messageInput">
                            <button class="btn btn-primary" type="button" id="sendButton">å‘é€</button>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="action-buttons">
                            <button class="action-btn" id="voiceButton">
                                <i class="fa fa-microphone"></i>
                            </button>
                            <button class="action-btn" id="imageButton">
                                <i class="fa fa-image"></i>
                            </button>
                            <button class="action-btn" id="fileButton">
                                <i class="fa fa-file"></i>
                            </button>
                            <button class="action-btn" id="settingsButton">
                                <i class="fa fa-cog"></i>
                            </button>
                        </div>

                        <!-- æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡†ï¼ˆéšè—ï¼‰ -->
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" />
                        <input type="file" id="fileInput" style="display: none;" />
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <div class="col-md-4">
                <div class="side-panel" id="sidePanel">
                    <!-- é¢æ¿å¤´éƒ¨ -->
                    <div class="panel-header">
                        <h4>æ§åˆ¶é¢æ¿</h4>
                    </div>

                    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="health">å¥åº·æ•°æ®</button>
                        <button class="tab-btn" data-tab="anomalies">å¼‚å¸¸æ£€æµ‹</button>
                        <button class="tab-btn" data-tab="iot">IoTæ§åˆ¶</button>
                    </div>

                    <!-- å¥åº·æ•°æ®é¢æ¿ -->
                    <div id="health-panel" class="tab-content active">
                        <div class="health-stats">
                            <div class="stat-card">
                                <h3>å¿ƒç‡</h3>
                                <div class="stat-value" id="heart-rate">--</div>
                                <div class="stat-unit">bpm</div>
                            </div>
                            <div class="stat-card">
                                <h3>ç¡çœ è´¨é‡</h3>
                                <div class="stat-value" id="sleep-quality">--</div>
                                <div class="stat-unit">%</div>
                            </div>
                            <div class="stat-card">
                                <h3>æ­¥æ•°</h3>
                                <div class="stat-value" id="steps">--</div>
                                <div class="stat-unit">æ­¥</div>
                            </div>
                            <div class="stat-card">
                                <h3>è¡€æ°§</h3>
                                <div class="stat-value" id="oxygen-level">--</div>
                                <div class="stat-unit">%</div>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="refresh-health" class="btn btn-primary">åˆ·æ–°å¥åº·æ•°æ®</button>
                            <button id="simulate-health" class="btn btn-secondary">ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®</button>
                        </div>
                    </div>

                    <!-- å¼‚å¸¸æ£€æµ‹é¢æ¿ -->
                    <div id="anomalies-panel" class="tab-content">
                        <div id="anomalies-list">
                            <p>æš‚æ— å¼‚å¸¸è®°å½•</p>
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button id="check-anomalies" class="btn btn-primary">æ£€æŸ¥å¼‚å¸¸</button>
                        </div>
                    </div>

                    <!-- IoTæ§åˆ¶é¢æ¿ -->
                    <div id="iot-panel" class="tab-content">
                        <div class="iot-devices">
                            <div class="device-card">
                                <h3>æ™ºèƒ½ç¯å…‰</h3>
                                <div class="device-status">
                                    <span class="status-indicator off"></span>
                                    <span>å…³é—­</span>
                                </div>
                                <div class="device-controls">
                                    <button class="device-btn" onclick="toggleDevice('light')">å¼€å…³</button>
                                    <button class="device-btn" onclick="setBrightness('light', 50)">äº®åº¦50%</button>
                                </div>
                            </div>
                            <div class="device-card">
                                <h3>æ™ºèƒ½ç©ºè°ƒ</h3>
                                <div class="device-status">
                                    <span class="status-indicator off"></span>
                                    <span>å…³é—­</span>
                                </div>
                                <div class="device-controls">
                                    <button class="device-btn" onclick="toggleDevice('ac')">å¼€å…³</button>
                                    <button class="device-btn" onclick="setTemperature('ac', 24)">24Â°C</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Bootstrap JS -->
    <script src="https://cdn.staticfile.net/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', async function() {
            // è·å–DOMå…ƒç´ 
            const chatBody = document.getElementById('chatBody');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const modelSelect = document.getElementById('modelSelect');
            const voiceReplySwitch = document.getElementById('voiceReplySwitch');
            const themeToggle = document.getElementById('themeToggle');
            const voiceButton = document.getElementById('voiceButton');
            const imageButton = document.getElementById('imageButton');
            const fileButton = document.getElementById('fileButton');
            const settingsButton = document.getElementById('settingsButton');
            const imageInput = document.getElementById('imageInput');
            const fileInput = document.getElementById('fileInput');
            const sidePanel = document.getElementById('sidePanel');
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const quickCommandBtns = document.querySelectorAll('.quick-command-btn');

            // ä¸»é¢˜åˆ‡æ¢
            function initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const isDarkMode = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    themeToggle.innerHTML = '<i class="fa fa-sun-o"></i>';
                } else {
                    document.body.classList.remove('dark-mode');
                    themeToggle.innerHTML = '<i class="fa fa-moon-o"></i>';
                }
            }

            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                themeToggle.innerHTML = isDarkMode ? '<i class="fa fa-sun-o"></i>' : '<i class="fa fa-moon-o"></i>';
            });

            // åˆå§‹åŒ–ä¸»é¢˜
            initTheme();

            // é…ç½®markedåº“
            marked.setOptions({
                breaks: true,
                gfm: true,
                highlight: function(code, lang) {
                    // æ£€æŸ¥Prismæ˜¯å¦å¯ç”¨
                    if (typeof Prism !== 'undefined') {
                        const language = Prism.languages[lang] || Prism.languages.plaintext;
                        return Prism.highlight(code, language, lang);
                    }
                    return code;
                }
            });

            // WebSocketé…ç½®
            let socket;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            const reconnectDelay = 2000;

            // åˆå§‹åŒ–WebSocketè¿æ¥
            function initWebSocket() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/chat`;
                
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(e) {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    reconnectAttempts = 0;
                    showNotification('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
                };
                
                socket.onmessage = function(event) {
                    try {
                        console.log('æ”¶åˆ°WebSocketå“åº”-è§£æå‰:', event.data);
                        const data = JSON.parse(event.data);
                        console.log('æ”¶åˆ°WebSocketå“åº”-è§£æå:', data);
                        
                        // ç§»é™¤æ­£åœ¨è¾“å…¥çš„æç¤º
                        const typingMessages = document.querySelectorAll('.typing-message');
                        typingMessages.forEach(msg => msg.remove());
                        
                        if (data.error) {
                            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                            addMessage('æŠ±æ­‰ï¼ŒAIè°ƒç”¨å¤±è´¥ï¼š' + data.error, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                            showNotification('AIè°ƒç”¨å¤±è´¥: ' + data.error, 'error');
                        } else {
                            // æ˜¾ç¤ºAIå›å¤
                            const modelName = data.model === 'aliyun' ? 'é˜¿é‡Œå¤§æ¨¡å‹ (Qwen-Turbo)' : 'Ollama (Llama3)';
                            addMessage(data.response, false, modelName);
                            
                            // è°ƒç”¨TTSåŠŸèƒ½ï¼Œå°†å›å¤è½¬æ¢ä¸ºè¯­éŸ³
                            if (voiceReplySwitch.checked) {
                                textToSpeech(data.response);
                            }
                            
                            showNotification('AIå›å¤å·²æ”¶åˆ°', 'success');
                        }
                    } catch (error) {
                        console.error('è§£æWebSocketå“åº”å¤±è´¥:', error);
                        addMessage('æŠ±æ­‰ï¼ŒAIå›å¤æ ¼å¼é”™è¯¯', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                        showNotification('è§£æå“åº”å¤±è´¥', 'error');
                    }
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                    showNotification('WebSocketè¿æ¥é”™è¯¯', 'error');
                };
                
                socket.onclose = function(event) {
                    console.log('WebSocketè¿æ¥å·²å…³é—­:', event.code, event.reason);
                    
                    // å°è¯•é‡è¿
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log(`å°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        setTimeout(initWebSocket, reconnectDelay);
                    } else {
                        console.error('WebSocketé‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
                        showNotification('WebSocketé‡è¿å¤±è´¥', 'error');
                    }
                };
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
            function addMessage(content, isUser, model = '') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble';
                
                // æ¶ˆæ¯å†…å®¹
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (isUser) {
                    // å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œæ”¯æŒåŸºæœ¬çš„é“¾æ¥å’Œè¡¨æƒ…
                    contentDiv.innerHTML = formatUserMessage(content);
                } else {
                    // æ¸²æŸ“markdown
                    try {
                        // é¢„å¤„ç†å†…å®¹ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
                        const processedContent = preprocessContent(content);
                        contentDiv.innerHTML = marked.parse(processedContent);
                        contentDiv.className = 'message-content markdown-content';
                        
                        // å¢å¼ºå¤„ç†ï¼šç¾åŒ–é“¾æ¥ã€æ·»åŠ äº¤äº’æ•ˆæœ
                        enhanceMessageContent(contentDiv);
                    } catch (e) {
                        // å¦‚æœmarkedè§£æå¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                        contentDiv.textContent = content;
                    }
                }
                
                // æ¶ˆæ¯ä¿¡æ¯
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                
                if (!isUser && model) {
                    infoDiv.innerHTML = `
                        <span class="model-info">${model}</span>
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                        <span class="message-status">
                            <i class="fa fa-check"></i>
                        </span>
                    `;
                }
                
                messageBubble.appendChild(contentDiv);
                messageBubble.appendChild(infoDiv);
                messageDiv.appendChild(messageBubble);
                
                // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
                chatBody.appendChild(messageDiv);
                
                // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    chatBody.scrollTop = chatBody.scrollHeight;
                }, 100);
            }

            // é¢„å¤„ç†æ¶ˆæ¯å†…å®¹
            function preprocessContent(content) {
                if (!content) return '';
                
                // ç§»é™¤å¤šä½™çš„ç©ºç™½å­—ç¬¦
                content = content.trim();
                
                // ç¡®ä¿ä»£ç å—æ ¼å¼æ­£ç¡®
                content = content.replace(/```([\s\S]*?)```/g, (match, code) => {
                    return '```\n' + code.trim() + '\n```';
                });
                
                // ç¡®ä¿æ ‡é¢˜æ ¼å¼æ­£ç¡®
                content = content.replace(/^(#{1,6})\s*(.+)$/gm, (match, hashes, text) => {
                    return hashes + ' ' + text.trim();
                });
                
                return content;
            }

            // å¤„ç†ç”¨æˆ·æ¶ˆæ¯
            function formatUserMessage(content) {
                if (!content) return '';
                
                // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
                content = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // è½¬æ¢é“¾æ¥ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
                content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">$1</a>');
                
                // è½¬æ¢è¡¨æƒ…ç¬¦å·
                content = content
                    .replace(/:\)/g, 'ğŸ˜Š')
                    .replace(/:\(/g, 'ğŸ˜¢')
                    .replace(/:\|/g, 'ğŸ˜')
                    .replace(/:D/g, 'ğŸ˜„')
                    .replace(/:P/g, 'ğŸ˜›')
                    .replace(/;\)/g, 'ğŸ˜‰')
                    .replace(/:O/g, 'ğŸ˜®')
                    .replace(/:S/g, 'ğŸ˜•')
                    .replace(/:\//g, 'ğŸ˜•');
                
                return content;
            }

            // å¢å¼ºæ¶ˆæ¯å†…å®¹
            function enhanceMessageContent(contentDiv) {
                // ç¾åŒ–é“¾æ¥
                const links = contentDiv.querySelectorAll('a');
                links.forEach(link => {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                    link.style.color = 'var(--primary-color)';
                    link.style.textDecoration = 'none';
                    link.style.borderBottom = '1px solid var(--primary-color)';
                    link.style.paddingBottom = '1px';
                    link.style.transition = 'all 0.2s ease';
                    
                    link.addEventListener('mouseenter', () => {
                        link.style.textDecoration = 'underline';
                        link.style.transform = 'translateY(-1px)';
                    });
                    
                    link.addEventListener('mouseleave', () => {
                        link.style.textDecoration = 'none';
                        link.style.transform = 'translateY(0)';
                    });
                });
                
                // ç¾åŒ–å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                const images = contentDiv.querySelectorAll('img');
                images.forEach(img => {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '8px';
                    img.style.margin = '12px 0';
                    img.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    img.style.transition = 'all 0.3s ease';
                    
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.02)';
                        img.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                        img.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    });
                });
                
                // å¢å¼ºä»£ç å—
                const codeBlocks = contentDiv.querySelectorAll('pre');
                codeBlocks.forEach(function(block) {
                    block.style.position = 'relative';
                    
                    // æ·»åŠ å¤åˆ¶æŒ‰é’®
                    var copyBtn = document.createElement('button');
                    copyBtn.textContent = 'å¤åˆ¶';
                    copyBtn.style.position = 'absolute';
                    copyBtn.style.top = '8px';
                    copyBtn.style.right = '8px';
                    copyBtn.style.background = 'rgba(0, 0, 0, 0.5)';
                    copyBtn.style.color = 'white';
                    copyBtn.style.border = 'none';
                    copyBtn.style.borderRadius = '4px';
                    copyBtn.style.padding = '4px 8px';
                    copyBtn.style.fontSize = '12px';
                    copyBtn.style.cursor = 'pointer';
                    copyBtn.style.opacity = '0';
                    copyBtn.style.transition = 'opacity 0.2s ease';
                    
                    block.appendChild(copyBtn);
                    
                    block.addEventListener('mouseenter', function() {
                        copyBtn.style.opacity = '1';
                    });
                    
                    block.addEventListener('mouseleave', function() {
                        copyBtn.style.opacity = '0';
                    });
                    
                    copyBtn.addEventListener('click', function() {
                        var code = block.querySelector('code').textContent;
                        navigator.clipboard.writeText(code).then(function() {
                            copyBtn.textContent = 'å·²å¤åˆ¶!';
                            setTimeout(function() {
                                copyBtn.textContent = 'å¤åˆ¶';
                            }, 2000);
                        });
                    });
                });
            }

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            function showTypingIndicator(modelName) {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message typing-message';
                typingDiv.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-content">
                            <div class="loading">
                                <div></div>
                                <div></div>
                                <div></div>
                                <div></div>
                            </div>
                            <span style="margin-left: 8px;">æ­£åœ¨è¾“å…¥...</span>
                        </div>
                        <div class="message-info">
                            <span class="model-info">${modelName}</span>
                            <span class="message-time">${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                `;
                chatBody.appendChild(typingDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºä»£ç ç¼–ç¨‹ç›¸å…³é—®é¢˜
            function isCodeRelated(query) {
                // ä»£ç ç›¸å…³å…³é”®è¯åˆ—è¡¨
                const codeKeywords = ['ä»£ç ', 'ç¼–ç¨‹', 'å¼€å‘', 'å†™ä¸ª', 'å®ç°', 'function', 'def', 'class', 'import', 'console.log', 'print', 'echo', 'return', 'if', 'else', 'for', 'while', 'loop', 'å˜é‡', 'å‡½æ•°', 'æ–¹æ³•', 'ç±»', 'å¯¹è±¡', 'æ•°ç»„', 'åˆ—è¡¨', 'å­—å…¸', 'æ˜ å°„', 'ç®—æ³•', 'æ•°æ®ç»“æ„', 'è®¾è®¡æ¨¡å¼', 'bug', 'è°ƒè¯•', 'ç¼–è¯‘', 'è¿è¡Œ', 'æµ‹è¯•'];
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»£ç ç›¸å…³å…³é”®è¯
                for (const keyword of codeKeywords) {
                    if (query.includes(keyword)) {
                        return true;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»£ç å—æ ‡è®°
                if (query.includes('```') || query.includes('`')) {
                    return true;
                }
                
                return false;
            }

            // é€‰æ‹©åˆé€‚çš„æ¨¡å‹
            function selectModel(query) {
                // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œä¸­æ–‡äº¤æµé»˜è®¤ä½¿ç”¨é˜¿é‡Œå¤§æ¨¡å‹
                // ä»£ç ç¼–ç¨‹è‡ªåŠ¨åˆ‡æ¢åˆ°deepseekï¼ˆä½†ç›®å‰deepseekæš‚ä¸æ”¯æŒï¼Œæ‰€ä»¥ä¿æŒä½¿ç”¨é˜¿é‡Œå¤§æ¨¡å‹ï¼‰
                // å¦‚æœé˜¿é‡Œå¤§æ¨¡å‹ä¸å“åº”ï¼Œåˆ™ä½¿ç”¨ollama
                
                // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ›´å¤æ‚çš„æ¨¡å‹é€‰æ‹©é€»è¾‘
                return 'aliyun';
            }

            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addMessage(message, true);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                
                // é€‰æ‹©åˆé€‚çš„æ¨¡å‹
                const selectedModel = selectModel(message);
                const modelName = selectedModel === 'aliyun' ? 'é˜¿é‡Œå¤§æ¨¡å‹ (Qwen-Turbo)' : 'Ollama (Llama3)';
                
                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                showTypingIndicator(modelName);
                
                // æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
                if (socket && socket.readyState === WebSocket.OPEN) {
                    // å‘é€WebSocketæ¶ˆæ¯
                    const wsMessage = JSON.stringify({
                        type: 'chat',
                        model: selectedModel,
                        query: message
                    });
                    socket.send(wsMessage);
                    console.log('å‘é€WebSocketæ¶ˆæ¯:', wsMessage);
                } else {
                    // WebSocketè¿æ¥ä¸å¯ç”¨ï¼Œå›é€€åˆ°HTTPè¯·æ±‚
                    console.log('WebSocketè¿æ¥ä¸å¯ç”¨ï¼Œå›é€€åˆ°HTTPè¯·æ±‚');
                    sendHttpMessage(message, selectedModel);
                }
            }

            // HTTPè¯·æ±‚å›é€€æ–¹æ¡ˆ
            async function sendHttpMessage(message, selectedModel) {
                try {
                    // æ„å»ºè¯·æ±‚URLï¼ŒæŒ‡å‘ java-jarvis æœåŠ¡ï¼Œä½¿ç”¨é€šç”¨èŠå¤©æ¥å£
                    const url = 'http://localhost:8000/api/chat';
                    
                    // å‘é€è¯·æ±‚
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: message, model: selectedModel })
                    });
                    
                    // è§£æå“åº”
                    const data = await response.json();
                    
                    // ç§»é™¤æ­£åœ¨è¾“å…¥çš„æç¤º
                    const typingMessages = document.querySelectorAll('.typing-message');
                    typingMessages.forEach(msg => msg.remove());
                    
                    // æ·»åŠ AIå›å¤
                    addMessage(data.response, false, selectedModel === 'aliyun' ? 'é˜¿é‡Œå¤§æ¨¡å‹ (Qwen-Max)' : 'Ollama (Llama3)');
                    
                    // è°ƒç”¨TTSåŠŸèƒ½
                    if (voiceReplySwitch.checked) {
                        textToSpeech(data.response);
                    }
                } catch (error) {
                    // ç§»é™¤æ­£åœ¨è¾“å…¥çš„æç¤º
                    const typingMessages = document.querySelectorAll('.typing-message');
                    typingMessages.forEach(msg => msg.remove());
                    
                    addMessage('æŠ±æ­‰ï¼Œæ¨¡å‹è¯·æ±‚å¤±è´¥ï¼š' + error.message, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification('æ¨¡å‹è¯·æ±‚å¤±è´¥', 'error');
                }
            }

            // è¯­éŸ³å½•åˆ¶ç›¸å…³å˜é‡
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;

            // è¯­éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            voiceButton.addEventListener('click', toggleVoiceRecording);

            // è¯­éŸ³å½•åˆ¶åŠŸèƒ½
            async function toggleVoiceRecording() {
                if (isRecording) {
                    // åœæ­¢å½•éŸ³
                    stopRecording();
                } else {
                    // å¼€å§‹å½•éŸ³
                    await startRecording();
                }
            }

            // å¼€å§‹å½•éŸ³
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        // å¤„ç†å½•åˆ¶çš„éŸ³é¢‘
                        processAudio();
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    voiceButton.innerHTML = '<i class="fa fa-stop"></i>';
                    voiceButton.style.backgroundColor = '#EF4444';
                    
                    // æ·»åŠ æ­£åœ¨å½•éŸ³çš„æç¤º
                    addMessage('æ­£åœ¨å½•éŸ³...', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification('å¼€å§‹å½•éŸ³', 'info');
                    
                } catch (error) {
                    console.error('å½•éŸ³å¤±è´¥:', error);
                    addMessage('æŠ±æ­‰ï¼Œå½•éŸ³å¤±è´¥ï¼š' + error.message, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification('å½•éŸ³å¤±è´¥', 'error');
                }
            }

            // åœæ­¢å½•éŸ³
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    voiceButton.innerHTML = '<i class="fa fa-microphone"></i>';
                    voiceButton.style.backgroundColor = '';
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    showNotification('åœæ­¢å½•éŸ³', 'info');
                }
            }

            // å¤„ç†å½•åˆ¶çš„éŸ³é¢‘
            async function processAudio() {
                if (audioChunks.length === 0) return;
                
                // åˆ›å»ºéŸ³é¢‘Blob
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = [];
                
                // æ˜¾ç¤ºæ­£åœ¨å¤„ç†éŸ³é¢‘çš„æç¤º
                addMessage('æ­£åœ¨å¤„ç†è¯­éŸ³...è¯·ç¨å€™', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                
                try {
                    // å°†éŸ³é¢‘è½¬æ¢ä¸ºBase64ç¼–ç 
                    const base64Audio = await blobToBase64(audioBlob);
                    
                    // ä½¿ç”¨WebSocketå‘é€éŸ³é¢‘æ•°æ®
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        const wsMessage = JSON.stringify({
                            type: 'audio',
                            model: 'aliyun',
                            audio: base64Audio
                        });
                        socket.send(wsMessage);
                        console.log('å‘é€éŸ³é¢‘æ•°æ®:', wsMessage.length, 'bytes');
                    } else {
                        // WebSocketä¸å¯ç”¨ï¼Œæ˜¾ç¤ºé”™è¯¯
                        addMessage('æŠ±æ­‰ï¼ŒWebSocketè¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•å‘é€è¯­éŸ³æ•°æ®', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                        showNotification('WebSocketä¸å¯ç”¨', 'error');
                    }
                } catch (error) {
                    console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                    addMessage('æŠ±æ­‰ï¼ŒéŸ³é¢‘å¤„ç†å¤±è´¥ï¼š' + error.message, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification('éŸ³é¢‘å¤„ç†å¤±è´¥', 'error');
                }
            }

            // Blobè½¬æ¢ä¸ºBase64
            function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // å›¾åƒä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            imageButton.addEventListener('click', () => {
                imageInput.click();
            });

            // å›¾åƒé€‰æ‹©äº‹ä»¶
            imageInput.addEventListener('change', handleImageUpload);

            // å¤„ç†å›¾åƒä¸Šä¼ 
            async function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // æ˜¾ç¤ºæ­£åœ¨å¤„ç†å›¾åƒçš„æç¤º
                addMessage('æ­£åœ¨å¤„ç†å›¾åƒ...è¯·ç¨å€™', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                showNotification('æ­£åœ¨ä¸Šä¼ å›¾åƒ', 'info');
                
                try {
                    // å‹ç¼©å›¾åƒ
                    const compressedImage = await compressImage(file);
                    
                    // å°†å‹ç¼©åçš„å›¾åƒè½¬æ¢ä¸ºBase64ç¼–ç 
                    const base64Image = await imageToBase64(compressedImage);
                    
                    // ä½¿ç”¨WebSocketå‘é€å›¾åƒæ•°æ®
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        const wsMessage = JSON.stringify({
                            type: 'image',
                            model: 'aliyun',
                            image: base64Image,
                            format: file.type.split('/')[1],
                            originalSize: file.size,
                            compressedSize: compressedImage.size
                        });
                        socket.send(wsMessage);
                        console.log('å‘é€å›¾åƒæ•°æ®:', wsMessage.length, 'bytes', 
                                  'åŸå§‹å¤§å°:', file.size, 'bytes', 
                                  'å‹ç¼©åå¤§å°:', compressedImage.size, 'bytes');
                        showNotification('å›¾åƒä¸Šä¼ æˆåŠŸ', 'success');
                    } else {
                        // WebSocketä¸å¯ç”¨ï¼Œæ˜¾ç¤ºé”™è¯¯
                        addMessage('æŠ±æ­‰ï¼ŒWebSocketè¿æ¥ä¸å¯ç”¨ï¼Œæ— æ³•å‘é€å›¾åƒæ•°æ®', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                        showNotification('WebSocketä¸å¯ç”¨', 'error');
                    }
                } catch (error) {
                    console.error('å›¾åƒå¤„ç†å¤±è´¥:', error);
                    addMessage('æŠ±æ­‰ï¼Œå›¾åƒå¤„ç†å¤±è´¥ï¼š' + error.message, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification('å›¾åƒå¤„ç†å¤±è´¥', 'error');
                }
            }

            // å‹ç¼©å›¾åƒ
            function compressImage(file) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
                        const maxWidth = 1280;
                        const maxHeight = 720;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                        
                        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç»˜åˆ¶å‹ç¼©åçš„å›¾åƒ
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å°†ç”»å¸ƒè½¬æ¢ä¸ºBlob
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('å›¾åƒå‹ç¼©å¤±è´¥'));
                            }
                        }, file.type, 0.8); // 0.8æ˜¯å‹ç¼©è´¨é‡
                    };
                    
                    img.onerror = function() {
                        reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            }

            // å›¾åƒè½¬æ¢ä¸ºBase64
            function imageToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // æ–‡ä»¶ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            fileButton.addEventListener('click', () => {
                fileInput.click();
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileUpload);

            // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // æ˜¾ç¤ºæ­£åœ¨å¤„ç†æ–‡ä»¶çš„æç¤º
                addMessage(`æ­£åœ¨å¤„ç†æ–‡ä»¶: ${file.name}...è¯·ç¨å€™`, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                showNotification(`æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ${file.name}`, 'info');
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘
                // ä¾‹å¦‚ï¼Œå°†æ–‡ä»¶å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œå¤„ç†
                setTimeout(() => {
                    addMessage(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`, false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    showNotification(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');
                }, 1000);
            }

            // TTSåŠŸèƒ½
            async function textToSpeech(text) {
                try {
                    // è°ƒç”¨GoæœåŠ¡çš„TTS API
                    const response = await fetch('/api/tts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            voice: 'default'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('TTS APIå“åº”:', data);
                        
                        // æ’­æ”¾éŸ³é¢‘ï¼ˆè¿™é‡Œéœ€è¦å¤„ç†Base64ç¼–ç çš„éŸ³é¢‘æ•°æ®ï¼‰
                        if (data.audio) {
                            playAudio(data.audio);
                        }
                    } else {
                        console.error('TTS APIè°ƒç”¨å¤±è´¥:', response.statusText);
                    }
                } catch (error) {
                    console.error('TTSåŠŸèƒ½å¤±è´¥:', error);
                }
            }

            // æ’­æ”¾éŸ³é¢‘æ•°æ®
            function playAudio(base64Audio) {
                try {
                    // åˆ›å»ºéŸ³é¢‘å…ƒç´ å¹¶æ’­æ”¾
                    const audio = new Audio(`data:audio/wav;base64,${base64Audio}`);
                    audio.play().catch(error => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                    });
                } catch (error) {
                    console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                }
            }

            // æ ‡ç­¾é¡µåˆ‡æ¢
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(panel => panel.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    btn.classList.add('active');
                    document.getElementById(targetTab + '-panel').classList.add('active');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°å¥åº·æ•°æ®é¢æ¿ï¼Œåˆ·æ–°æ•°æ®
                    if (targetTab === 'health') {
                        refreshHealthData();
                    }
                    // å¦‚æœåˆ‡æ¢åˆ°å¼‚å¸¸æ£€æµ‹é¢æ¿ï¼Œæ£€æŸ¥å¼‚å¸¸
                    if (targetTab === 'anomalies') {
                        checkAnomalies();
                    }
                });
            });

            // åˆ·æ–°å¥åº·æ•°æ®
            const refreshHealthBtn = document.getElementById('refresh-health');
            refreshHealthBtn.addEventListener('click', refreshHealthData);

            async function refreshHealthData() {
                try {
                    const now = new Date();
                    const endTime = now.toISOString().replace('Z', '+08:00');
                    const startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().replace('Z', '+08:00');
                    
                    const response = await fetch(`/api/health-data?userId=default-user&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`);
                    const healthDataList = await response.json();
                    
                    // å¤„ç†å¥åº·æ•°æ®
                    updateHealthStats(healthDataList);
                    showNotification('å¥åº·æ•°æ®å·²åˆ·æ–°', 'success');
                } catch (error) {
                    console.error('è·å–å¥åº·æ•°æ®å¤±è´¥:', error);
                    showNotification('è·å–å¥åº·æ•°æ®å¤±è´¥', 'error');
                }
            }

            // æ›´æ–°å¥åº·æ•°æ®ç»Ÿè®¡
            function updateHealthStats(healthDataList) {
                // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿healthDataListæ˜¯æ•°ç»„
                if (!Array.isArray(healthDataList)) {
                    console.error('è·å–å¥åº·æ•°æ®å¤±è´¥: healthDataListä¸æ˜¯æ•°ç»„', healthDataList);
                    showNotification('è·å–å¥åº·æ•°æ®å¤±è´¥: æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                    return;
                }
                
                // æŒ‰æ•°æ®ç±»å‹åˆ†ç»„
                const dataByType = healthDataList.reduce((acc, data) => {
                    if (!acc[data.type]) {
                        acc[data.type] = [];
                    }
                    acc[data.type].push(data);
                    return acc;
                }, {});
                
                // æ›´æ–°å„ä¸ªæŒ‡æ ‡
                ['HEART_RATE', 'SLEEP_QUALITY', 'STEPS', 'OXYGEN_LEVEL'].forEach(type => {
                    if (dataByType[type] && dataByType[type].length > 0) {
                        // è·å–æœ€æ–°æ•°æ®
                        const latestData = dataByType[type].sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        })[0];
                        
                        const elementId = type.toLowerCase().replace('_', '-');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = latestData.value;
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼
                        const elementId = type.toLowerCase().replace('_', '-');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = '-';
                        }
                    }
                });
            }

            // ç”Ÿæˆæ¨¡æ‹Ÿå¥åº·æ•°æ®
            const simulateHealthBtn = document.getElementById('simulate-health');
            simulateHealthBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/health-data/simulate?userId=default-user');
                    const healthDataList = await response.json();
                    updateHealthStats(healthDataList);
                    showNotification('æ¨¡æ‹Ÿå¥åº·æ•°æ®å·²ç”Ÿæˆ', 'success');
                } catch (error) {
                    console.error('ç”Ÿæˆæ¨¡æ‹Ÿå¥åº·æ•°æ®å¤±è´¥:', error);
                    showNotification('ç”Ÿæˆæ¨¡æ‹Ÿå¥åº·æ•°æ®å¤±è´¥', 'error');
                }
            });

            // æ£€æŸ¥å¼‚å¸¸
            const checkAnomaliesBtn = document.getElementById('check-anomalies');
            checkAnomaliesBtn.addEventListener('click', checkAnomalies);

            async function checkAnomalies() {
                try {
                    const response = await fetch('/api/anomalies/check?userId=default-user');
                    const anomalies = await response.json();
                    updateAnomaliesList(anomalies);
                    showNotification('å¼‚å¸¸æ£€æµ‹å®Œæˆ', 'success');
                } catch (error) {
                    console.error('æ£€æŸ¥å¼‚å¸¸å¤±è´¥:', error);
                    showNotification('æ£€æŸ¥å¼‚å¸¸å¤±è´¥', 'error');
                }
            }

            // æ›´æ–°å¼‚å¸¸åˆ—è¡¨
            function updateAnomaliesList(anomalies) {
                const anomaliesList = document.getElementById('anomalies-list');
                
                if (!Array.isArray(anomalies) || anomalies.length === 0) {
                    anomaliesList.innerHTML = '<p>æš‚æ— å¼‚å¸¸è®°å½•</p>';
                    return;
                }
                
                anomaliesList.innerHTML = '';
                
                anomalies.forEach(anomaly => {
                    const anomalyItem = document.createElement('div');
                    anomalyItem.className = `anomaly-item ${anomaly.severity.toLowerCase()}`;
                    anomalyItem.innerHTML = `
                        <h5>${anomaly.type}</h5>
                        <p>${anomaly.description}</p>
                        <div style="font-size: 0.8rem; color: var(--text-light);">
                            <span>æ—¶é—´: ${new Date(anomaly.timestamp).toLocaleString()}</span>
                            <span style="margin-left: 12px;">ä¸¥é‡ç¨‹åº¦: ${anomaly.severity}</span>
                        </div>
                    `;
                    anomaliesList.appendChild(anomalyItem);
                });
            }

            // IoTè®¾å¤‡æ§åˆ¶
            window.toggleDevice = function(deviceId) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ è®¾å¤‡æ§åˆ¶çš„é€»è¾‘
                const deviceCard = document.querySelector(`.device-card h3:contains(${deviceId === 'light' ? 'ç¯å…‰' : 'ç©ºè°ƒ'})`).parentElement;
                const statusIndicator = deviceCard.querySelector('.status-indicator');
                const statusText = deviceCard.querySelector('.device-status span:last-child');
                
                if (statusIndicator.classList.contains('off')) {
                    statusIndicator.classList.remove('off');
                    statusIndicator.classList.add('on');
                    statusText.textContent = 'å¼€å¯';
                    showNotification(`${deviceId === 'light' ? 'ç¯å…‰' : 'ç©ºè°ƒ'}å·²å¼€å¯`, 'success');
                } else {
                    statusIndicator.classList.remove('on');
                    statusIndicator.classList.add('off');
                    statusText.textContent = 'å…³é—­';
                    showNotification(`${deviceId === 'light' ? 'ç¯å…‰' : 'ç©ºè°ƒ'}å·²å…³é—­`, 'success');
                }
            };

            window.setBrightness = function(deviceId, brightness) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ è®¾ç½®äº®åº¦çš„é€»è¾‘
                showNotification(`ç¯å…‰äº®åº¦å·²è®¾ç½®ä¸º ${brightness}%`, 'success');
            };

            window.setTemperature = function(deviceId, temperature) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ è®¾ç½®æ¸©åº¦çš„é€»è¾‘
                showNotification(`ç©ºè°ƒæ¸©åº¦å·²è®¾ç½®ä¸º ${temperature}Â°C`, 'success');
            };

            // å¿«æ·å‘½ä»¤
            quickCommandBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    messageInput.value = command;
                    sendMessage();
                });
            });

            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }

            // åŠ è½½å†å²èŠå¤©è®°å½•
            async function loadChatHistory() {
                try {
                    // ç›´æ¥æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼Œä¸è¯·æ±‚ä¸å­˜åœ¨çš„ç«¯ç‚¹
                    // æ¸…ç©ºå½“å‰èŠå¤©çª—å£
                    chatBody.innerHTML = '';
                    
                    // æ·»åŠ ç³»ç»Ÿæ¬¢è¿æ¶ˆæ¯
                    addMessage('ä½ å¥½ï¼æˆ‘æ˜¯è´¾ç»´æ–¯ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚', false, 'ç³»ç»Ÿæ¶ˆæ¯');
                    console.log('èŠå¤©çª—å£åˆå§‹åŒ–å®Œæˆï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯');
                } catch (error) {
                    console.error('åˆå§‹åŒ–èŠå¤©çª—å£å¤±è´¥:', error);
                }
            }

            // ç»‘å®šäº‹ä»¶
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // åˆå§‹åŒ–
            await loadChatHistory();
            initWebSocket();
            initTheme();

            // å“åº”å¼èœå•ï¼ˆç§»åŠ¨ç«¯ï¼‰
            if (window.innerWidth <= 768) {
                // æ·»åŠ ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®
                const sidebarToggle = document.createElement('button');
                sidebarToggle.className = 'action-btn';
                sidebarToggle.style.position = 'fixed';
                sidebarToggle.style.bottom = '20px';
                sidebarToggle.style.right = '20px';
                sidebarToggle.style.zIndex = '999';
                sidebarToggle.innerHTML = '<i class="fa fa-bars"></i>';
                sidebarToggle.addEventListener('click', () => {
                    sidePanel.classList.toggle('open');
                });
                document.body.appendChild(sidebarToggle);
            }
        });
    </script>
</body>
</html>